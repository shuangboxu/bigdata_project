# 项目构成说明

## 项目概述

本项目是一个基于 LangGraph 的信用风险分析系统，采用多智能体架构实现端到端的数据分析工作流。项目整合了传统的命令行工具（CLI）和现代的 LangGraph 智能体框架，可以对信用风险数据进行探索性分析、机器学习建模、可视化展示和自动化报告生成。

## 核心技术栈

- **Python 数据科学栈**: pandas, numpy, scikit-learn, matplotlib
- **智能体编排框架**: LangGraph
- **大语言模型集成**: OpenAI API
- **数据处理**: openpyxl (Excel), scipy
- **模板引擎**: Jinja2
- **环境管理**: python-dotenv

## 目录结构详解

### 1. `agent_flow/` - LangGraph 智能体模块

这是项目的核心智能体编排层，包含基于 LangGraph 的多智能体工作流实现。

- **`planner.py`** - 数据规划智能体
  - 负责生成高层次的执行计划
  - 定义数据处理、特征工程、模型训练、评估等步骤
  - 将原始数据框传递给后续节点

- **`executor.py`** - 数据执行智能体
  - 执行实际的数据处理和模型训练任务
  - 清洗数据并处理缺失值
  - 训练梯度提升分类器
  - 收集模型指标和预测结果

- **`visualizer.py`** - 可视化智能体
  - 生成 ROC 曲线等可视化图表
  - 将图表保存到 `artifacts/classification/` 目录

- **`reporter.py`** - 报告生成智能体
  - 使用 OpenAI API 生成智能分析报告（当配置了 API 密钥时）
  - 提供回退模板以确保工作流始终能完成
  - 生成 Markdown 格式的分析报告

- **`run_workflow.py`** - 工作流运行器
  - 整合所有智能体节点
  - 定义状态图和节点间的数据流
  - 生成 HTML 格式的综合摘要报告 (`reports/workflow_overview.html`)

- **`utils.py`** - 工具函数
  - 提供数据加载和通用辅助功能

### 2. `src/` - 核心数据科学模块

包含可复用的数据处理和建模代码，被智能体和 CLI 工具调用。

- **`config.py`** - 配置管理
  - 定义默认输入路径和全局配置参数

- **`io_utils.py`** - 输入输出工具
  - 实现健壮的数据读取器（支持 Excel 和 CSV）
  - 处理不同格式的自动识别和回退

- **`schema.py`** - 数据模式定义
  - 定义数据结构和类型约束

- **`preprocess.py`** - 数据预处理
  - 数据清洗和转换
  - 缺失值处理
  - 异常值检测

- **`features.py`** - 特征工程
  - 特征构建和转换
  - 特征选择逻辑

- **`split.py`** - 数据分割
  - 训练集/验证集/测试集划分
  - 支持时间序列感知的分割策略

- **`eda.py`** - 探索性数据分析
  - 生成数据摘要统计
  - 创建分布图和相关性分析

- **`pipeline_cls.py`** - 分类建模管道
  - 实现完整的分类模型训练流程
  - 使用梯度提升分类器处理类别不平衡问题
  - 生成混淆矩阵和性能指标

- **`pipeline_reg.py`** - 回归建模管道
  - 实现回归模型训练流程
  - 支持连续变量预测

- **`cluster.py`** - 聚类分析
  - 实现无监督学习算法
  - K-means 聚类和轮廓分析

- **`evaluate.py`** - 模型评估
  - 计算各类性能指标（准确率、F1、AUC 等）
  - 生成评估报告

- **`report.py`** - 报告编译
  - 将分析结果编译成结构化报告
  - 支持 Markdown 和 HTML 输出

- **`templates/`** - 报告模板
  - 存储 Jinja2 模板文件用于报告生成

### 3. `artifacts/` - 模型和结果存储

持久化存储所有分析产出物。

- **`classification/`** - 分类任务输出
  - 训练好的分类模型
  - ROC 曲线图 (`roc_curve_agent.png`)
  - 混淆矩阵图
  - 模型性能指标 JSON 文件

- **`regression/`** - 回归任务输出
  - 回归模型和预测结果
  - 实际值 vs 预测值散点图

- **`clustering/`** - 聚类任务输出
  - 聚类模型
  - 聚类轮廓图和剖面分析

- **`eda/`** - 探索性分析输出
  - 数据分布图
  - 相关性热图
  - 统计摘要

### 4. `reports/` - 分析报告

存储生成的各类报告文档。

- **`agent_llm_report.md`** - LangGraph 智能体生成的 LLM 增强报告
- **`workflow_overview.html`** - 工作流综合摘要（HTML 格式）
- **`report.md`** - 传统 CLI 工具生成的标准报告
- **`English_Project_Design_Report.md`** - 项目设计英文报告

### 5. `data/` - 数据目录

存储输入数据集（此目录通常不纳入版本控制）。

- **`数据示例.xlsx`** - 示例数据集（Lending Club 风格的贷款组合数据）
  - 包含 10,722 条贷款记录
  - 44 个特征变量
  - 二分类目标变量（违约/非违约）

### 6. 根目录文件

- **`main.py`** - 传统 CLI 入口点
  - 提供命令行接口访问各个功能模块
  - 支持独立运行 EDA、训练、聚类等任务
  - 不依赖 LangGraph 框架

- **`llm_insights.py`** - LLM 洞见生成
  - 调用大语言模型增强报告内容
  - 可选功能，需要配置 OpenAI API 密钥

- **`requirements.txt`** - Python 依赖清单
  - 列出所有必需的第三方库及版本要求

- **`README.md`** - 项目文档（英文）
  - 环境配置说明
  - 使用指南和示例
  - 故障排查指导

- **`.env.example`** - 环境变量示例
  - API 密钥配置模板
  - 数据路径配置示例

## 工作流程说明

### LangGraph 智能体工作流

这是推荐的使用方式，提供端到端自动化：

```bash
python -m agent_flow.run_workflow --data data/数据示例.xlsx
```

**执行流程**：
1. **Planner（规划器）** → 生成执行计划并传递原始数据
2. **Executor（执行器）** → 清洗数据、训练模型、收集指标
3. **Visualizer（可视化器）** → 生成 ROC 曲线等图表
4. **Reporter（报告器）** → 生成 Markdown 分析报告
5. **HTML Summary（HTML 摘要）** → 汇总所有结果为交互式网页

**关键输出**：
- `artifacts/classification/roc_curve_agent.png`
- `reports/agent_llm_report.md`
- `reports/workflow_overview.html`

### 传统 CLI 工具

独立的命令行工具，适合单独执行特定任务：

```bash
# 探索性数据分析
python main.py eda --in data/数据示例.xlsx

# 监督学习 - 分类
python main.py train-cls --in data/数据示例.xlsx --target grade

# 监督学习 - 回归
python main.py train-reg --in data/数据示例.xlsx --target interestRate

# 无监督学习 - 聚类
python main.py cluster --in data/数据示例.xlsx

# 生成静态报告包
python main.py report

# 使用 LLM 增强报告（可选）
python main.py report-llm
```

## 数据流和状态管理

LangGraph 工作流使用 `WorkflowState` TypedDict 在节点间传递状态：

- **data**: 原始/清洗后的 pandas DataFrame
- **plan**: 执行计划（步骤列表）
- **metrics**: 模型性能指标字典
- **model**: 训练好的模型对象
- **roc_path**: ROC 曲线图保存路径
- **report_text**: 生成的 Markdown 报告文本
- **html_path**: HTML 摘要文件路径

## 特性亮点

### 1. 双模式运行
- **智能体模式**：完全自动化的端到端工作流
- **CLI 模式**：灵活的单步执行控制

### 2. 健壮的数据处理
- 自动检测并处理二分类目标变量
- 智能的缺失值填充策略
- 处理类别严重不平衡问题

### 3. 可选的 LLM 增强
- 配置 OpenAI API 密钥后可获得智能分析洞见
- 未配置时使用确定性模板保证工作流完整性

### 4. 完善的可视化
- ROC 曲线、混淆矩阵
- 聚类轮廓图
- 数据分布和相关性图表

### 5. 可追溯性
- 所有模型和图表持久化存储
- 生成详细的 HTML 和 Markdown 报告
- 记录执行计划和步骤

## 技术架构特点

1. **模块化设计**：核心逻辑与编排层分离，易于维护和扩展
2. **智能体协作**：不同角色的智能体专注各自职责
3. **状态驱动**：使用类型化状态在智能体间安全传递数据
4. **容错机制**：多层回退策略确保工作流鲁棒性
5. **可扩展性**：易于添加新的智能体节点或替换模型算法

## 使用场景

- **信用风险建模**：评估贷款违约概率
- **自动化报告**：生成可审计的分析文档
- **模型实验**：快速迭代不同的特征工程和建模策略
- **教学演示**：展示端到端机器学习流程
- **原型开发**：为生产系统快速验证想法

## 环境要求

- Python 3.8+
- 推荐使用虚拟环境
- 可选：OpenAI API 密钥（用于 LLM 增强功能）

## 贡献与扩展

项目采用清晰的分层架构，便于扩展：

- 添加新的智能体节点：在 `agent_flow/` 中创建新模块
- 扩展建模能力：在 `src/` 中添加新的 pipeline
- 增强可视化：扩展 `visualizer.py` 或添加新图表类型
- 自定义报告：修改 `src/templates/` 中的模板

## 总结

本项目成功结合了传统数据科学工作流与现代智能体编排技术，提供了一个可重现、可审计、易扩展的信用风险分析平台。通过 LangGraph 框架的编排，实现了从数据摄入到报告生成的全自动化流程，同时保持了足够的灵活性以支持自定义和扩展需求。
